<!DOCTYPE html><html prefix="og: http://ogp.me/ns#"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>12306火车票查询 · Let's go for a walk around the world - zuo</title><meta name="description" content="12306火车票查询 - John Doe"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.ico"><link rel="stylesheet" href="//at.alicdn.com/t/font_1472710214_6648843.css"><link rel="stylesheet" href="//raw.githack.com/xwartz/hexo-theme-nuna/next/source/style/main.css?v=1.0.3"></head><body class="pupa"><div class="loading-bar"></div><main><div class="post post"><article itemscope itemtype="http://schema.org/Article" class="hentry"><div itemprop="image" style="background-image: url(http://otlbf411d.bkt.clouddn.com/18-6-5/91501792.jpg)" class="entry-cover"></div><div class="container"><div class="entry-header"><h1 class="entry-title">12306火车票查询</h1><div class="entry-description"></div><div class="entry-meta"><time itemprop="datePublished" datetime="Saturday, June 2nd 2018, 9:00:00 pm" class="updated">Jun 2, 2018</time><em class="post-count">1,830 words</em></div></div><div itemprop="articleBody" class="entry-content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>通过12306官网的几个接口来获取火车余票信息，结合邮件模块发现余票时就发送邮件给自己提示，虽然达不到黄牛那种毫秒级别，秒级别的速度，在不繁忙的线路和时间段还是有点用处。<br><strong>注</strong>：目前版本只做了余票查询，后期有时间再加入票价信息等，由于12306登陆验证码以及登陆态的失效时间实在变态，要实现完全自动化还需购买付费人工打码服务，因此暂时不不计划做自动购票功能。</p>
<h2 id="查询余票接口"><a href="#查询余票接口" class="headerlink" title="查询余票接口"></a>查询余票接口</h2><p>首先打开12306官网，并进入<a href="https://kyfw.12306.cn/otn/leftTicket/init" target="_blank" rel="external"><u>余票查询</u></a>页面，同时开启chrome浏览器F12控制台，以北京到上海为例，搜索2018年6月5日的余票信息，点击搜索按钮，可以在控制台发送了一条GET请求，请求结果以json字符串的形式放回，里面有查询到的余票信息。</p>
<p><img src="http://otlbf411d.bkt.clouddn.com/18-6-5/5071589.jpg" alt=""></p>
<p>通过python-requests来请求一下这个接口，比较意外的是这个接口并没有校验header信息，因此我们不用添加header。在测试中发现虽然12306官网主页提供了证书下载，但是这个https请求并不是必须校验证书，将requests方法中的verify参数设置为False取消校验也能正常返回结果。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> requests</div><div class="line"></div><div class="line">url = <span class="string">'https://kyfw.12306.cn/otn/leftTicket/query?leftTicketDTO.train_date=2018-06-05&amp;leftTicketDTO.from_station=BJP&amp;leftTicketDTO.to_station=SHH&amp;purpose_codes=ADULT'</span></div><div class="line">requests.packages.urllib3.disable_warnings()</div><div class="line">r = requests.get(url,verify=<span class="keyword">False</span>).json()</div><div class="line">yupiao = r[<span class="string">'data'</span>][<span class="string">'result'</span>]</div><div class="line">print(yupiao)</div></pre></td></tr></table></figure></p>
<p>如下图返回结果是个列表，每一个元素就是一条火车线路，包含始发站代码，终点站代码，发车时间，每种座位的余票等信息，通过” | “分隔，需要注意的是每种座位的余票数量与网页展示的位置前后顺序并不是一一对应的，这个花了不少时间来确定每个对应关系。<br><img src="http://otlbf411d.bkt.clouddn.com/18-6-5/17290359.jpg" alt=""></p>
<p>将上一步返回结果放入循环中，每一个元素按照” | “符号分割，并从分割后的列表中依次取出需要的内容（城市代码，时间，车次，作为余票等信息）。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> requests</div><div class="line"><span class="keyword">from</span> tabulate <span class="keyword">import</span> tabulate</div><div class="line"></div><div class="line"><span class="comment">#查询余票</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">query</span><span class="params">()</span>:</span></div><div class="line">    url = <span class="string">'https://kyfw.12306.cn/otn/leftTicket/query?leftTicketDTO.train_date=2018-06-05&amp;leftTicketDTO.from_station=BJP&amp;leftTicketDTO.to_station=SHH&amp;purpose_codes=ADULT'</span></div><div class="line">    requests.packages.urllib3.disable_warnings()</div><div class="line">    r = requests.get(url,verify=<span class="keyword">False</span>).json()</div><div class="line">    yupiao = r[<span class="string">'data'</span>][<span class="string">'result'</span>]</div><div class="line"></div><div class="line">    table_header = [<span class="string">'车次'</span>,<span class="string">'始发站'</span>,<span class="string">'终点站'</span>,<span class="string">'始发时间'</span>,<span class="string">'到站时间'</span>,<span class="string">'历时'</span>,<span class="string">'商务特等座'</span>,<span class="string">'一等座'</span>,<span class="string">'二等座'</span>,<span class="string">'高级软卧'</span>,<span class="string">'软卧'</span>,<span class="string">'动卧'</span>,<span class="string">'硬卧'</span>,<span class="string">'软座'</span>,<span class="string">'硬座'</span>,<span class="string">'无座'</span>]  <span class="comment">#表格头</span></div><div class="line"></div><div class="line">    table_data = []  <span class="comment">#数据添加至列表，作为表格的主体内容</span></div><div class="line"></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> yupiao:</div><div class="line">        a = i.split(<span class="string">'|'</span>)           <span class="comment">#分割字符串，a是个列表</span></div><div class="line"></div><div class="line">        is_null = a[<span class="number">0</span>]             <span class="comment">#判断是否有票</span></div><div class="line">        train_code = a[<span class="number">3</span>]          <span class="comment">#车次</span></div><div class="line">        start_city_code = a[<span class="number">4</span>]     <span class="comment">#始发站城市代码</span></div><div class="line">        end_city_code = a[<span class="number">5</span>]       <span class="comment">#终点站城市代码</span></div><div class="line">        start_time = a[<span class="number">8</span>]          <span class="comment">#终点站开始时间</span></div><div class="line">        end_time = a[<span class="number">9</span>]            <span class="comment">#终点站到达时间</span></div><div class="line">        total_time = a[<span class="number">10</span>]         <span class="comment">#总共历时</span></div><div class="line">        shangwutedeng = a[<span class="number">32</span>]      <span class="comment">#商务特等座</span></div><div class="line">        yideng = a[<span class="number">31</span>]             <span class="comment">#一等座</span></div><div class="line">        erdeng = a[<span class="number">30</span>]             <span class="comment">#二等座</span></div><div class="line">        gaojiruanwo = a[<span class="number">21</span>]        <span class="comment">#高级软卧</span></div><div class="line">        ruanwo = a[<span class="number">23</span>]             <span class="comment">#软卧</span></div><div class="line">        dongwo = a[<span class="number">33</span>]             <span class="comment">#动卧</span></div><div class="line">        yingwo = a[<span class="number">28</span>]             <span class="comment">#硬卧</span></div><div class="line">        ruanzuo = a[<span class="number">24</span>]            <span class="comment">#软座</span></div><div class="line">        yingzuo = a[<span class="number">29</span>]            <span class="comment">#硬座</span></div><div class="line">        wuzuo = a[<span class="number">26</span>]              <span class="comment">#无座</span></div><div class="line"></div><div class="line">        <span class="comment">#添加到元组</span></div><div class="line">        yupiao_tuple = (train_code,start_city_code,end_city_code,start_time,end_time,total_time,shangwutedeng,yideng,erdeng,gaojiruanwo,ruanwo,dongwo,yingwo,ruanzuo,yingzuo,wuzuo)</div><div class="line">        table_data.append(yupiao_tuple)</div><div class="line">    print(tabulate(table_data,headers=table_header,tablefmt=<span class="string">'grid'</span>))</div></pre></td></tr></table></figure></p>
<p>在上面代码中使用了<code>tabulate</code>库，它可以把结果输出成易读的表格样式，<a href="https://python-book.readthedocs.io/zh_CN/latest/libs/tabulate.html" target="_blank" rel="external"><u>更多使用方法点击这里</u></a>。</p>
<p><img src="http://otlbf411d.bkt.clouddn.com/18-6-5/29355983.jpg" alt=""></p>
<h2 id="参数化准备"><a href="#参数化准备" class="headerlink" title="参数化准备"></a>参数化准备</h2><p>再回头看之前请求的URL，这个GET请求有四个请求参数，分别代表如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">leftTicketDTO.train_date       --&gt;      乘车日期</div><div class="line">leftTicketDTO.from_station     --&gt;      始发站代码(例如北京北：VAP)</div><div class="line">leftTicketDTO.to_station       --&gt;      终点站代码(例如上海虹桥：AOH)</div><div class="line">purpose_codes                  --&gt;      车票类型(普通票：ADULT，学生票：0X00)</div></pre></td></tr></table></figure></p>
<p>第一个和第四个参数好填写，始发站和终点站代码我们现在并没有对应的表，不知道每个站点对应的代码，在网站上找一下。我们在页面上手动修改始发站和终点站的时候发现并没有发送新的https请求，可以猜测所有的站点信息应该是在一个js文件里面，然后通过页面的js方法来选择不同的站名，现在F12控制台切换至JS模块下，刷新这个余票查询页面。</p>
<p><img src="http://otlbf411d.bkt.clouddn.com/18-6-5/11512788.jpg" alt=""><br>从上图可以看到刷新页面后有个名称为station_name.js的js文件，单击一看果然是存放了所有的站点信息，将这个文件的url复制重新打开一个页面可以看到，火车站点信息放在station_name变量后面的字符串，中间有很多” | “作为分隔符，观察发现每五个符号分隔的内容为一组，刚好是一个站点的信息。</p>
<p><img src="http://otlbf411d.bkt.clouddn.com/18-6-5/80561012.jpg" alt=""></p>
<p>我们需要把这个很长的字符串重新分隔成我们想要的格式，将这个很长的字符串全部复制到一个py文件,通过以下函数来处理：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#查询每个站点名称/拼音/缩写/代码</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_station_code</span><span class="params">()</span>:</span></div><div class="line">    code = all_station.split(<span class="string">'|'</span>)   <span class="comment">#字符串的所有信息按照"|"符号分割，结果是一个列表</span></div><div class="line">    n = <span class="number">5</span>  <span class="comment"># 大列表中几个数据组成一个小列表，每五个元素为一个站点信息组合</span></div><div class="line">    station_code = [code[i:i + n] <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, len(code), n)]  <span class="comment">#每一个火车站点信息为一个元素放在此列表</span></div><div class="line">    print(station_code)</div></pre></td></tr></table></figure></p>
<p>执行结果如下，长字符串已经被转换成一个大列表，列表中的每个元素分别是一个小列表，小列表包含火车站点的五个信息，其中最后一个小列表只有一个元素，应该是备用的字段现在没有用，直接删除。<br><img src="http://otlbf411d.bkt.clouddn.com/18-6-5/74374072.jpg" alt=""></p>
<h2 id="用户输入判断"><a href="#用户输入判断" class="headerlink" title="用户输入判断"></a>用户输入判断</h2><p>上一步已经整理好了所有的火车站点信息，下面代码实现用户输入火车站名时找到对应的站点代码，<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#根据用户输入的站点名或者缩写在站点列表中检索对应的代码</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">retrieve_station</span><span class="params">()</span>:</span></div><div class="line">    a = input(<span class="string">'请输入始发站、终点站、日期，用一个空格隔开，按回车键查询，参考格式：北京 上海 20180605\n:'</span>)</div><div class="line">    start_city = a.split(<span class="string">' '</span>)[<span class="number">0</span>]</div><div class="line">    end_city = a.split(<span class="string">' '</span>)[<span class="number">1</span>]</div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        date = str(a.split(<span class="string">' '</span>)[<span class="number">2</span>])</div><div class="line">        <span class="keyword">if</span> len(date) == <span class="number">8</span>:   <span class="comment">#用户日期是否是8位正整数</span></div><div class="line">            newdate = date[:<span class="number">4</span>] + <span class="string">'-'</span> + date[<span class="number">4</span>:<span class="number">6</span>] + <span class="string">'-'</span> + date[<span class="number">6</span>:]  <span class="comment">#转换为查询接口所需的日期参数格式，例如2018-06-08</span></div><div class="line">            <span class="keyword">break</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            print(<span class="string">'日期输入有误，请重新输入'</span>)</div><div class="line"></div><div class="line">    <span class="comment">#检索始发站代码</span></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> station_code:  <span class="comment">#station_code就是上一步整理好的站点列表</span></div><div class="line">        <span class="keyword">if</span> start_city == i[<span class="number">1</span>]:</div><div class="line">            start_city_code = i[<span class="number">2</span>]  <span class="comment">#始发站代码</span></div><div class="line">            <span class="keyword">break</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">pass</span></div><div class="line"></div><div class="line">    <span class="comment">#检索目的地代码</span></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> station_code:   <span class="comment">#station_code就是上一步整理好的站点列表</span></div><div class="line">        <span class="keyword">if</span> end_city == i[<span class="number">1</span>]:</div><div class="line">            end_city_code = i[<span class="number">2</span>]  <span class="comment">#终点站代码</span></div><div class="line">            <span class="keyword">break</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">pass</span></div><div class="line">    <span class="keyword">return</span> newdate,start_city_code,end_city_code</div></pre></td></tr></table></figure></p>
<p>上面的函数执行后返回日期,始发站代码，终点站代码，将它们格式化传到请求的URL中重新请求就得到了想要的结果，修改之前的查询余票函数如下。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#查询余票</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">query</span><span class="params">()</span>:</span></div><div class="line">    station_info = retrieve_station()</div><div class="line">    url = <span class="string">'https://kyfw.12306.cn/otn/leftTicket/query?leftTicketDTO.train_date=%s&amp;leftTicketDTO.from_station=%s&amp;leftTicketDTO.to_station=%s&amp;purpose_codes=ADULT'</span> %(station_info[<span class="number">0</span>],station_info[<span class="number">1</span>],station_info[<span class="number">2</span>])</div><div class="line">    ...</div></pre></td></tr></table></figure></p>
<h2 id="最终效果"><a href="#最终效果" class="headerlink" title="最终效果"></a>最终效果</h2><p><img src="http://otlbf411d.bkt.clouddn.com/18-6-5/40413405.jpg" alt=""></p>
<font color="white">xx</font>




<p><div class="paginator"><a href="/archives/" class="all">more</a></div><footer><div class="copyright container"><p>    .</p></div></footer></p>
</div><div class="entry-extra"><div class="entry-tags"><a href="/tags/测试/" class="tag">测试</a><a href="/tags/python/" class="tag">python</a><a href="/tags/接口测试/" class="tag">接口测试</a></div></div></div></article></div></main><footer><div class="copyright container"><p>© Copyright 2018 by <a href="http://yoursite.com">John Doe</a>.</p></div></footer><script async src="//cdn.bootcss.com/mathjax/2.7.0-beta.0/MathJax.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-69822347-1",'auto');
ga('set', 'appName',"Let's go for a walk around the world - zuo");
ga('send','pageview');</script><script>(function () { var sid =500303098;cid =500303108;var hm = document.createElement('script');
hm.src = 'http://pingjs.qq.com/h5/stats.js';
hm.setAttribute('name', 'MTAH5'); hm.setAttribute('sid', sid); hm.setAttribute('cid', cid);
var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);
}())</script><script>var _vds = _vds || [];
window._vds = _vds;
(function(){
  ;_vds.push(['setAccountId',"90b580e047dd0007"  ]);
  (function() {
      var vds = document.createElement('script');
      vds.type='text/javascript';
      vds.async = true;
      vds.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'dn-growing.qbox.me/vds.js';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(vds, s);
  })();
})();</script><script async src="//raw.githack.com/Easyfood/pageAccelerator/master/dist/page-accelerator.min.js"></script><script async src="/script/loading.js"></script><script async src="/script/photo.js"></script></body></html>